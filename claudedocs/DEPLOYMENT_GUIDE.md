# Production Deployment Guide - Render

Complete guide for deploying the insurance chatbot with admin authentication to Render.com

---

## ðŸ“‹ Prerequisites

Before deployment, ensure you have:

1. âœ… GitHub account with this repository pushed
2. âœ… Render.com account (free tier available)
3. âœ… Supabase project set up with PostgreSQL database
4. âœ… OpenAI API key
5. âœ… (Optional) Telegram bot token for escalations
6. âœ… (Optional) Azure AD credentials for email notifications

---

## ðŸš€ Quick Deployment (Render Blueprint)

Render will automatically deploy both backend and frontend using the `render.yaml` file.

### Step 1: Connect Repository to Render

1. Go to [Render Dashboard](https://dashboard.render.com/)
2. Click **"New"** â†’ **"Blueprint"**
3. Connect your GitHub repository
4. Select this repository (`insurance-chatbot`)
5. Render will detect the `render.yaml` file

### Step 2: Configure Environment Variables

Render will prompt you to set the following **required** environment variables:

#### Backend API Service (`insurance-chatbot-api`)

**Required Variables:**
```bash
# OpenAI API
OPENAI_API_KEY=sk-your-openai-api-key

# Supabase Configuration
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_ANON_KEY=your-supabase-anon-key
SUPABASE_SERVICE_KEY=your-supabase-service-role-key
SUPABASE_CONNECTION_STRING=postgresql://postgres.[PROJECT-REF]:[PASSWORD]@db.[PROJECT-REF].supabase.co:6543/postgres

# JWT Secret (auto-generated by Render, or set manually)
JWT_SECRET=your-secure-random-secret-minimum-32-characters

# CORS Origin (set to your frontend URL after deployment)
CORS_ORIGIN=https://insurance-chatbot-admin.onrender.com
```

**Optional Variables:**
```bash
# Telegram Bot (for escalations)
TELEGRAM_BOT_TOKEN=your-telegram-bot-token
TELEGRAM_CHAT_ID=your-telegram-group-chat-id

# Azure AD (for email notifications)
AZURE_CLIENT_ID=your-azure-client-id
AZURE_CLIENT_SECRET=your-azure-client-secret
AZURE_TENANT_ID=your-azure-tenant-id
AZURE_SERVICE_ACCOUNT_USERNAME=notifications@yourcompany.com
AZURE_SERVICE_ACCOUNT_PASSWORD=your-service-account-password

# Email Configuration
LOG_REQUEST_EMAIL_FROM=notifications@yourcompany.com
LOG_REQUEST_EMAIL_TO=support-team@yourcompany.com
```

#### Frontend Admin Service (`insurance-chatbot-admin`)

The frontend automatically gets `VITE_API_URL` from the backend service, so no manual configuration is needed!

### Step 3: Deploy Services

1. Click **"Apply"** to create all services
2. Render will create:
   - âœ… Backend API service (Node.js web service)
   - âœ… Frontend Admin service (Static site)
   - âœ… Redis service (for sessions)
3. Wait for all services to deploy (5-10 minutes)

### Step 4: Run Database Migration

Once the backend is deployed:

1. Open your Supabase SQL Editor
2. Run the migration script:

```bash
# Get your Supabase connection string from dashboard
# Go to: Settings > Database > Connection String (Transaction mode)

# Connect to Supabase and run migration
psql "YOUR_SUPABASE_CONNECTION_STRING" < backend/migrations/create_admin_auth_tables.sql
```

Or run it directly in Supabase SQL Editor:

```sql
-- Copy the entire contents of backend/migrations/create_admin_auth_tables.sql
-- Paste and execute in Supabase SQL Editor
```

### Step 5: Create Super Admin Account

SSH into your Render backend service or run locally:

```bash
# Option 1: Run locally (requires backend/.env with SUPABASE_CONNECTION_STRING)
cd backend
node scripts/setup-admin.js

# Option 2: Use Render Shell
# Go to: Render Dashboard > Backend Service > Shell
cd backend
node scripts/setup-admin.js
```

**Save the generated credentials immediately!**

### Step 6: Update CORS Configuration

After frontend deploys, update the backend `CORS_ORIGIN` environment variable:

1. Go to Render Dashboard â†’ Backend Service â†’ Environment
2. Update `CORS_ORIGIN` to include your frontend URL:
   ```
   https://insurance-chatbot-admin.onrender.com
   ```
3. Click **"Save Changes"**
4. Backend will automatically redeploy

---

## ðŸ”§ Manual Deployment (Step-by-Step)

If you prefer manual setup instead of Blueprint:

### 1. Create Redis Service

1. New â†’ Redis
2. Name: `insurance-chatbot-redis`
3. Plan: Starter (Free)
4. Region: Singapore (or your preferred region)
5. Click **"Create Redis"**

### 2. Create Backend API Service

1. New â†’ Web Service
2. Connect repository
3. Configuration:
   - **Name**: `insurance-chatbot-api`
   - **Runtime**: Node
   - **Region**: Singapore
   - **Build Command**: `cd backend && npm install`
   - **Start Command**: `cd backend && npm start`
   - **Plan**: Starter ($7/month)

4. Add all environment variables (see Step 2 above)

5. Advanced Settings:
   - **Health Check Path**: `/health`
   - **Auto-Deploy**: Yes

6. Add Persistent Disk:
   - **Name**: `chatbot-uploads`
   - **Mount Path**: `/opt/render/project/src/backend/uploads`
   - **Size**: 1 GB

7. Click **"Create Web Service"**

### 3. Create Frontend Admin Service

1. New â†’ Static Site
2. Connect repository
3. Configuration:
   - **Name**: `insurance-chatbot-admin`
   - **Runtime**: Node
   - **Region**: Singapore
   - **Build Command**: `cd frontend/admin && npm install && npm run build`
   - **Publish Directory**: `frontend/admin/dist`
   - **Plan**: Free

4. Environment Variables:
   - `NODE_ENV`: `production`
   - `VITE_API_URL`: `https://insurance-chatbot-api.onrender.com`

5. Add Custom Headers:
   ```
   X-Frame-Options: DENY
   X-Content-Type-Options: nosniff
   Referrer-Policy: strict-origin-when-cross-origin
   ```

6. Configure Rewrite Rules:
   - **Source**: `/*`
   - **Destination**: `/index.html`
   - **Type**: Rewrite

7. Click **"Create Static Site"**

---

## ðŸ”’ Post-Deployment Security Checklist

### Immediate Actions (After First Deployment)

- [ ] âœ… Change Super Admin password from generated password
- [ ] âœ… Verify `JWT_SECRET` is set to strong random value (32+ characters)
- [ ] âœ… Update `CORS_ORIGIN` to actual frontend URL
- [ ] âœ… Test login functionality at `https://your-admin.onrender.com/login`
- [ ] âœ… Verify session timeout works (30 minutes)
- [ ] âœ… Test password change functionality
- [ ] âœ… Verify Super Admin can create/manage admin users

### Regular Security Maintenance

- [ ] Rotate `JWT_SECRET` every 90 days
- [ ] Review admin user list monthly
- [ ] Check audit logs for suspicious activity
- [ ] Update dependencies: `npm audit` and `npm update`
- [ ] Review failed login attempts in logs

---

## ðŸ§ª Testing Deployment

### 1. Backend Health Check

```bash
curl https://insurance-chatbot-api.onrender.com/health
```

Expected response:
```json
{
  "status": "healthy",
  "timestamp": "2025-01-14T...",
  "uptime": 123.45,
  "redis": "connected"
}
```

### 2. Frontend Access

Visit: `https://insurance-chatbot-admin.onrender.com`

- âœ… Should see login page
- âœ… No console errors
- âœ… Can login with Super Admin credentials

### 3. Authentication Flow

1. Login with Super Admin credentials
2. Navigate to Admin Users
3. Create a new admin account
4. Logout and login with new account
5. Verify "Admin Users" is NOT visible (not Super Admin)
6. Test password change
7. Test session timeout (wait 30 minutes)

### 4. API Integration

1. Navigate to Dashboard
2. Check if data loads from API
3. Test employee management
4. Test knowledge base operations
5. Test chat history

---

## ðŸ“Š Monitoring & Logs

### View Logs in Render

1. Go to Render Dashboard
2. Select service (backend or frontend)
3. Click **"Logs"** tab
4. Monitor for errors:
   - Authentication failures
   - Database connection issues
   - Redis connection issues
   - Rate limiting triggers

### Key Log Patterns to Monitor

**Normal Operations:**
```
âœ“ Server running on port 10000
âœ“ Redis: connected
âœ“ Health Check: healthy
```

**Authentication Issues:**
```
âš  [Auth] Unauthenticated request to /api/admin from IP: xxx.xxx.xxx.xxx
âš  [Auth] Invalid token: jwt expired
âš  [Auth] Session not found or expired for user: xxx
```

**Errors to Investigate:**
```
âŒ Error: ECONNREFUSED (Redis down)
âŒ Error connecting to Supabase
âŒ Error: rate limit exceeded
```

---

## ðŸ”§ Troubleshooting

### Issue: CORS Errors in Browser Console

**Solution:**
1. Check `CORS_ORIGIN` in backend environment variables
2. Ensure it includes the exact frontend URL (including `https://`)
3. No trailing slash in URL
4. Restart backend service after changing

### Issue: "Authentication Required" on All Requests

**Solution:**
1. Check browser cookies are enabled
2. Verify `JWT_SECRET` is set in backend
3. Check Redis service is running and connected
4. Try clearing browser cookies and logging in again

### Issue: Session Expires Immediately

**Solution:**
1. Verify Redis service is running
2. Check `REDIS_URL` in backend environment variables
3. Ensure `SESSION_TIMEOUT_MINUTES=30` is set
4. Check Redis connection in health endpoint

### Issue: Cannot Create Admin Users

**Solution:**
1. Verify you're logged in as Super Admin
2. Check database migration ran successfully
3. Verify `SUPABASE_CONNECTION_STRING` is correct
4. Check backend logs for database errors

### Issue: Build Fails on Render

**Backend Build Failure:**
```bash
# Check package.json is present in backend/
# Verify all dependencies are listed
cd backend && npm install --production
```

**Frontend Build Failure:**
```bash
# Check Vite config is correct
# Verify all dependencies are listed
cd frontend/admin && npm install && npm run build
```

---

## ðŸ’° Cost Estimation

### Render Free Tier
- âœ… Frontend Admin: **Free** (Static Site)
- âœ… Redis: **Free** (Starter plan - 25MB)

### Render Paid Services
- ðŸ’µ Backend API: **$7/month** (Starter plan - 512MB RAM)

### External Services (Required)
- ðŸ’µ Supabase: **Free** (up to 500MB database, 2GB bandwidth)
- ðŸ’µ OpenAI API: **Pay-as-you-go** (depends on usage)

**Total Minimum Cost: $7/month** (Render backend only)

### Scaling Recommendations

**When to upgrade:**
- Backend RAM >80%: Upgrade to Standard ($25/month, 2GB RAM)
- Redis storage >20MB: Upgrade to Redis 256MB ($10/month)
- Database >500MB: Upgrade Supabase to Pro ($25/month)

---

## ðŸ”„ CI/CD & Auto-Deploy

Render automatically deploys on every push to `main` branch.

### Disable Auto-Deploy

1. Go to Service â†’ Settings
2. Toggle **"Auto-Deploy"** off
3. Manual deploys only via dashboard

### Deploy Specific Branch

1. Go to Service â†’ Settings
2. Change **"Branch"** to your desired branch
3. Click **"Save Changes"**

### Manual Deploy

1. Go to Service dashboard
2. Click **"Manual Deploy"** â†’ **"Deploy latest commit"**

---

## ðŸ“š Additional Resources

- [Render Documentation](https://render.com/docs)
- [Supabase Documentation](https://supabase.com/docs)
- [OpenAI API Reference](https://platform.openai.com/docs/api-reference)
- [Redis Documentation](https://redis.io/documentation)

---

## ðŸŽ‰ Deployment Complete!

Your insurance chatbot with admin authentication is now live in production!

**Next Steps:**
1. Share admin credentials securely with your team
2. Create additional admin accounts as needed
3. Configure company settings in admin dashboard
4. Upload knowledge base documents
5. Test chatbot widget on your website
6. Monitor logs for issues

**Support:**
- Check `SETUP_GUIDE.md` for admin features
- Review `README.md` for project overview
- Check Render logs for runtime issues

---

**Security Reminder:** Never commit `.env` files or expose API keys in logs!
